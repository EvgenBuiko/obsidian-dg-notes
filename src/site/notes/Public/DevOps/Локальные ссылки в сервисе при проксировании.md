---
{"dg-publish":true,"permalink":"/Public/DevOps/Локальные ссылки в сервисе при проксировании/","tags":["DevOps","Public"]}
---

С проблемой столкнулся столько раз что мне кажется что об этом стоит написать. 
## Описание проблемы:

```mermaid
flowchart TD
A["пользователь"] -- DNS --> B["сервак"]
A -- "клик 1.2.3.4:8080/блабла и естественно это не работает" --> D["сервис 1"]	
B --> C["Nginx/Apache"]
B -- крутится со встроенным веб сервером (контейнер к примеру) --> D
C -- "проксируем из вася.пупкин.бел в 1.2.3.4:8080" --> D
D -- "Возвращает страницу а там 1.2.3.4:8080/блабла" --> A
```

Попытка как то редиректить невозможно. Логично но если тупишь то может оказаться неочевидно: **как только ты пользователю отдал ссылку 1.2.3.4:8080/блабла ты уже бессилен ибо обращение по ней до тебя никогда не долетит хоть в схеме это и нарисовано**
## Решение:

### 1. Сделать нормально

Ага да может быть когда нибудь. Если вы в такой ситуации то этот пункт вам с большой долей вероятности не подходит ибо тут на мой взгляд архитектурно хочется плакать. Но всё же пропишу подробнее.
#### Встроенный веб сервер
Это на всё время использования для вас окажется третьей ногой которой вы не всегда можете управлять. В моём частном случае один из таких сервисов был gitlab. Они рекомендуют отключать встроенный nginx если вы используете собственный. Абсолютно с ними согласен. Если такая возможность есть - делайте это обязательно. 
### 2. Nginx sub_filter или его аналог в Apache
Штука до нельзя простая от того и рабочая - парсит контент страницы подменяя аргумент 1 на аргумент 2. 

> [!warning]  Однако
> Серьёзный вытекающий из принципа работы команды минус: данный метод требует убрать компрессию

Как я понял это должно быть прописано в самом конце. Но это не точно)

Пример:

```nginx
location ... {
		...
	proxy_set_header Accept-Encoding ""; 
	# Fix direct links  
	sub_filter "1.2.3.4:8080/" "вася.пупкин.бел/";  
	sub_filter_once off;
}
```
